<%= form_with(model: [:admin, order], local: true, html: { class: "card p-4 shadow-sm" }) do |form| %>
  <% if order.errors.any? %>
    <div class="alert alert-danger mb-4">
      <h5><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h5>
      <ul class="mb-0">
        <% order.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <h2 class="mb-4"><%= order.persisted? ? "Edit Order" : "New Order" %></h2>

  <div class="mb-3">
    <%= form.label :user_id, "Customer", class: "form-label fw-bold" %>
    <% if order.persisted? %>
      <%= form.collection_select :user_id, User.where(id: order.user_id), :id, :email, {}, { class: "form-select", disabled: true } %>
      <%= form.hidden_field :user_id %>
    <% else %>
      <%= form.collection_select :user_id, User.all.where(role: "buyer"), :id, :email, 
          { prompt: "Select a customer" }, 
          { class: "form-select" } %>
    <% end %>
  </div>

  <div class="mb-3">
    <%= form.label :status, class: "form-label fw-bold" %>
    <%= form.select :status, 
        Order::STATUSES.reject { |s| s == "paid" },
        { prompt: "Select status" }, 
        { class: "form-select" } %>
  </div>

  <h4 class="mt-4 mb-3">Order Items</h4>
  <div class="table-responsive mb-3">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody>
        <%= form.fields_for :order_items do |item_fields| %>
          <tr>
            <td>
              <%= item_fields.collection_select :product_id, Product.all.where(status: "published"), :id, :name, { prompt: "Select product" }, class: "form-select" %>
            </td>

            <td>
              <%= item_fields.check_box :_destroy %>
              <span class="text-muted">Remove</span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="mb-3">
    <%= link_to "Add Item", "#", id: "add-item", class: "btn btn-outline-success" %>
  </div>

  <div class="d-flex justify-content-end mt-4">
    <%= form.submit order.persisted? ? "Update Order" : "Create Order", class: "btn btn-primary" %>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const addItemBtn = document.getElementById("add-item");
      addItemBtn.addEventListener("click", function(e) {
        e.preventDefault();
        const tbody = document.querySelector("table.table-hover tbody");
        const index = tbody.querySelectorAll("tr").length;

        const newRow = document.createElement("tr");
        newRow.innerHTML = `
          <td>
            <select name="order[order_items_attributes][${index}][product_id]" class="form-select">
              <option value="">Select product</option>
              <% Product.all.where(status: "published").each do |product| %>
                <option value="<%= product.id %>"><%= product.name %></option>
              <% end %>
            </select>
          </td>
          <td>
            <input type="checkbox" name="order[order_items_attributes][${index}][_destroy]" />
            <span class="text-muted">Remove</span>
          </td>
        `;
        tbody.appendChild(newRow);
      });
    });
  </script>
<% end %>