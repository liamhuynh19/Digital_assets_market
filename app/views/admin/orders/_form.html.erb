<%= form_with(model: [:admin, order], local: true, html: { class: "card p-4 shadow-sm" }) do |form| %>
  <% readonly = order.status == "paid" %>

  <% if order.errors.any? %>
    <div class="alert alert-danger mb-4">
      <h5><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h5>
      <ul class="mb-0">
        <% order.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <h2 class="mb-4"><%= order.persisted? ? "Edit Order" : "New Order" %></h2>

  <div class="mb-3">
    <%= form.label :user_id, "Customer", class: "form-label fw-bold" %>
    <% if order.persisted? %>
      <%= form.collection_select :user_id, User.where(id: order.user_id), :id, :email, {}, { class: "form-select", disabled: true } %>
      <%= form.hidden_field :user_id %>
    <% else %>
      <%= form.collection_select :user_id, User.all.where(role: "buyer"), :id, :email, 
          { prompt: "Select a customer" }, 
          { class: "form-select", disabled: readonly } %>
    <% end %>
  </div>

  <div class="mb-3">
    <%= form.label :status, class: "form-label fw-bold" %>
    <% if readonly %>
      <div class="form-control-plaintext">
        <span class="badge bg-success"><%= order.status.capitalize %></span>
      </div>
      <%= form.hidden_field :status %>
    <% else %>
      <%= form.select :status, 
          Order::STATUSES.reject { |s| s == "paid" },
          { prompt: "Select status" }, 
          { class: "form-select" } %>
    <% end %>
  </div>

  <h4 class="mt-4 mb-3">Order Items</h4>
  <div class="table-responsive mb-3">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody>
        <%= form.fields_for :order_items do |item_fields| %>
          <tr>
            <td>
              <%= item_fields.collection_select :product_id, Product.all.where(status: "published"), :id, :name, { prompt: "Select product" }, class: "form-select", disabled: readonly %>
            </td>
            <td>
              $<%= Product.find_by(id: item_fields.object.product_id)&.price || "0.00" %>
            </td>
            <td>
              <% unless readonly %>
                <%= item_fields.check_box :_destroy %>
                <span class="text-muted">Remove</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% unless readonly %>
    <div class="mb-3">
      <%= link_to "Add Item", "#", id: "add-item", class: "btn btn-outline-success" %>
    </div>
    <div class="d-flex justify-content-end mt-4">
      <%= form.submit order.persisted? ? "Update Order" : "Create Order", class: "btn btn-primary" %>
    </div>
  <% end %>
<% end %>