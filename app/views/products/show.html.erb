<div class="container my-5">
  <%= link_to "Back to products", products_path, class: "btn btn-secondary position-absolute", style: "top: 20px; right: 20px; z-index: 2;" %>
  <div class="card shadow rounded-4 overflow-hidden" style="max-width: 700px; margin: auto; position: relative;">
    <% if @product.asset.attached? %>
      <div class="bg-dark">
        <% if @product.asset.content_type.start_with?('image/') %>
          <% if !@product.purchased_by?(current_user) && @product.preview.present?%>          
            <%= image_tag @product.preview, class: "card-img-top rounded-0", style: "height: 400px; object-fit: cover;" %>
          <% else %> 
            <%= image_tag @product.asset, class: "card-img-top rounded-0", style: "height: 400px; object-fit: cover;" %>
          <% end %>
        <% elsif @product.asset.content_type.start_with?('video/') && !@product.purchased_by?(current_user) && @product.preview.present? %>
          <%= video_tag url_for(@product.preview), 
              controls: true, 
              autoplay: true, 
              class: "card-img-top rounded-0", 
              style: "height: 400px; object-fit: cover;", 
              disablePictureInPicture: true, 
              controlsList: "nodownload" %>
            <% else %>
              <%= video_tag url_for(@product.asset), 
              controls: true, 
              autoplay: true, 
              class: "card-img-top rounded-0", 
              style: "height: 400px; object-fit: cover;", 
              disablePictureInPicture: true, 
              controlsList: "nodownload" %>
        <% end %>
      </div>
      
      <% if @product.purchased_by?(current_user) %>
        <div class="bg-light border-bottom">
          <div class="container-fluid px-4 py-3">
            <div class="d-flex justify-content-end align-items-center">
              <div class="d-flex align-items-center gap-3">
                <% if @product.asset.content_type.start_with?('video/') %>
                  <select id="resolution" class="form-select form-select-sm w-auto">
                    <% if @product.video_hd.attached? %>
                      <option value="hd" selected>HD (1080x720)</option>
                    <% end %>
                    <% if @product.video_full_hd.attached? %>
                      <option value="full_hd" <%= @product.video_hd.attached? ? '' : 'selected' %>>Full HD (1920x1080)</option>
                    <% end %>
                    <% if @product.video_4k.attached? %>
                      <option value="4k" <%= (@product.video_hd.attached? || @product.video_full_hd.attached?) ? '' : 'selected' %>>4K (4096x2160)</option>
                    <% end %>
                  </select>
                <% end %>
                <button id="download-btn" 
                        class="btn btn-gradient fw-bold" 
                        style="background: linear-gradient(90deg, #6f42c1 0%, #487ecf 100%); color: #fff;">
                  <i class="fas fa-download"></i> Download
                </button>
              </div>
            </div>
          </div>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function() {
            var downloadBtn = document.getElementById("download-btn");
            var resolutionSelect = document.getElementById("resolution");
            
            downloadBtn.addEventListener("click", function(e) {
              e.preventDefault();
              
              var downloadUrl = "<%= download_product_path(@product) %>";
              
              if (resolutionSelect && resolutionSelect.value) {
                downloadUrl += "?resolution=" + resolutionSelect.value;
              }
              
              window.open(downloadUrl, '_blank');
            });
          });
        </script>
      <% end %>

      <div class="card-body">
        <h2 class="card-title mb-3 fw-bold"><%= @product.name %></h2>
        <p class="card-text text-muted"><%= @product.description %></p>

        <p class="mb-2"><strong>Average rating:</strong> <%= @product.average_rating %> / 5</p>

        <hr>

        <h5 class="mb-3">Reviews</h5>

        <% @product.reviews.includes(:user).order(created_at: :desc).each do |review| %>
          <div class="mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between">
              <div>
                <strong><%= review.user.email %></strong>
                <span class="text-warning ms-2">
                  <%= "★" * review.rating %><%= "☆" * (5 - review.rating.to_i) %>
                </span>
              </div>
              <% if review.user_id == current_user&.id %>
                <div class="d-flex gap-2">
                  <%= link_to "Edit",
                              edit_product_review_path(@product, review),
                              data: { turbo_frame: "review_form" },
                              class: "btn btn-sm btn-outline-secondary" %>
                  <%= link_to "Delete",
                              product_review_path(@product, review),
                              data: { turbo_method: :delete, turbo_confirm: "Delete your review?" },
                              class: "btn btn-sm btn-outline-danger" %>
                </div>
              <% end %>
            </div>
            <p class="mb-0 mt-2"><%= review.comment %></p>
          </div>
        <% end %>

        <% if user_signed_in? && @product.purchased_by?(current_user) %>
          <hr>
          <% if @product.reviews.exists?(user_id: current_user.id) %>
            
            <%= turbo_frame_tag "review_form" do %>
           
              <!-- Click "Edit" above to load the form here -->
            <% end %>
          <% else %>
            <h5 id="review-form" class="mb-3"><%= @review&.persisted? ? "Edit your review" : "Write a review" %></h5>
            <%= render "reviews/form", review: @review %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
