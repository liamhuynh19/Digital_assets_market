<% content_for :title, "Products" %>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0 fw-bold gradient-text display-5">Products</h1>
    <div class="d-flex align-items-center gap-3">
      <%= search_form_for @q, class: "d-flex align-items-center" do |f| %>
        <% if params.dig(:q, :name_cont).present? %>
          <%= f.hidden_field :name_cont, value: params.dig(:q, :name_cont) %>
        <% end %>
        <%= f.select :category_id_eq,
          options_from_collection_for_select(Category.all, :id, :name, f.object.category_id_eq),
          { include_blank: 'All Categories' },
          { 
            class: "form-select form-select-sm glass-select py-1",
            style: "font-size: 0.875rem; min-width: 120px;",
            onchange: 'this.form.submit()'
          } 
        %>
        <%= f.select :s,
          options_for_select([
            ['Latest', 'created_at desc'],
            ['Name: A to Z', 'name asc'],
            ['Name: Z to A', 'name desc'],
            ['Price: Low to High', 'price asc'],
            ['Price: High to Low', 'price desc'],
            ['Rating: High to Low', 'average_rating desc'],
            ['Rating: Low to High', 'average_rating asc']
          ], params.dig(:q, :s) || f.object.s || 'created_at desc'),
          {},
          { 
            class: "form-select form-select-sm glass-select py-1",
            style: "font-size: 0.875rem; min-width: 150px;",
            onchange: 'this.form.submit()'
          } 
        %>
      <% end %>
    </div>
  </div>
    
  <div class="row g-4">
    <% @products.each do |product| %>
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card product-card h-100 border-0 shadow-lg">
          <div class="card-image-wrapper">
            <%= image_tag product.thumbnail.presence || asset_path("place_holder.jpg") , class: "card-img-top product-image" %>
            <div class="card-overlay">
              <div class="overlay-buttons d-flex flex-column gap-2">
                <%= link_to product_path(product), class: "btn btn-light btn-sm glass-button w-100" do %>
                  <i class="fas fa-eye"></i> View
                <% end %>
                <% if product.purchased_by?(current_user) %>
                  <%= link_to download_product_path(product),
                      class: "btn btn-primary btn-sm glass-button w-100 text-white fw-bold",
                      style: "background: linear-gradient(90deg, #6f42c1 0%, #487ecf 100%); border: none; backdrop-filter: blur(8px); opacity: 0.7;" do %>
                    <i class="fas fa-download"></i> Download
                  <% end %>
                <% else %>
                  <%= button_to cart_add_to_cart_path(@cart, product), 
                      class: "btn btn-success btn-sm glass-button w-100 text-white fw-bold",
                      style: "background: linear-gradient(90deg, #43e97b 0%, #023a30ff 100%); border: none; backdrop-filter: blur(8px); opacity: 0.7;",
                      form: { class: "d-inline-block" },
                      data: { turbo: true } do %>
                    <i class="fas fa-cart-plus"></i> Add to Cart
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
          
          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-1 fw-semibold"><%= product.name %></h5>
            <p class="text-muted small mb-2">
              <i class="fas fa-tag me-1"></i>
              <%= product.category&.name %>
            </p>
            <div class="d-flex justify-content-between align-items-center mt-auto">
              <div class="price-tag">
                <span class="price">$<%= number_with_precision(product.price, precision: 2) %></span>
              </div>
              <div class="rating">
                <% product.average_rating.to_i.times do %>
                  <i class="fas fa-star text-warning"></i>
                <% end %>
                <% (5 - product.average_rating.to_i).times do %>
                  <i class="far fa-star text-warning"></i>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%= render "shared/pagination_toolbar",
           collection: @products,
           per_page_options: [3, 6, 12, 24, 48, 96],
           label: "products" %>
</div>
